$(document).ready(function(){var e=location.pathname.match(/pins\/(?:new|[^\/]+\/edit)/);if(e){var i="pins/new"!==e[0],n=".form-inline",a=$("#preview-template").html(),t=0,o=0;Dropzone.autoDiscover=!1,i||$("#submit-all").prop("disabled",!0);var l={previewsContainer:"#dropper",clickable:"#dropper",maxFilesize:1,previewTemplate:a,paramName:function(e){return"pin_images["+e+"][photo]"},addRemoveLinks:!0,headers:{"X-CSRF-Token":$('meta[name="csrf-token"]').attr("content")},autoProcessQueue:!1,uploadMultiple:!0,parallelUploads:100,maxFiles:10,init:function(){var e=document.querySelector("#submit-all");r=this,e.addEventListener("click",function(e){r.getQueuedFiles().length>0&&(e.preventDefault(),r.processQueue())})}},r=new Dropzone(n,l);r.on("addedfile",function(e){$(".dz-message:visible").hide(),e.index=t++,$(".dz-preview:last-child").attr("id","file-"+e.index),$("#submit-all").prop("disabled",!1)}),r.on("removedfile",function(e){0==$(".dz-preview:visible").length&&($(".dz-message").show(),$("#submit-all").prop("disabled",!0)),i&&$.ajax({url:"pin_images/"+e.id,type:"DELETE"})}),r.on("sending",function(e,i,n){var a="#file-"+e.index+" .caption";n.append("pin_images["+o++ +"]caption",$(a).val())}),r.on("sendingmultiple",function(){tinyMCE.triggerSave()}),r.on("successmultiple",function(e,a){if(i){var t=$(n).data("pin-id");window.location.href="/pins/"+t}else window.location.href="/pins/"+a.id}),r.on("errormultiple",function(e,i){$("#error_explanation ul").empty(),i.forEach(function(e){$("#error_explanation ul").append("<li>"+e+"</li>")})}),i&&($(".dz-message:visible").hide(),$.getJSON("pin_images.json",function(e){return e&&e.forEach(function(e){r.options.addedfile.call(r,e),$(e.previewElement).attr("data-pin-image-id",e.id),$(e.previewElement).children("input").val(e.caption),r.options.thumbnail.call(r,e,e.url)}),$("input.caption").on("change",function(e){var i=$(this.parentElement).data("pin-image-id"),n=$(this),a=n.val();$.ajax({url:"/pin_images/"+i+".json",type:"PUT",data:{id:i,caption:a},success:function(){n.css("border-color","green"),n.append("\u2714")}})}),e}))}});